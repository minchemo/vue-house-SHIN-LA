<template>
  <div class="order relative bg-[#003399] text-center">
    <div class="order1 relative">
      <div class="title text-white mb-3">
        <!-- <div class="text-4xl font-bold mb-3">DREAM PARK</div> -->
        <div class="mb-3">
          <svg class="title-logo" viewBox="0 0 341 41" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6.54297 33.2871H11.6211C14.4141 33.2871 16.5046 33.1009 17.8926 32.7285C19.2975 32.3561 20.5163 31.7298 21.5488 30.8496C22.9538 29.6478 24.0033 28.1582 24.6973 26.3809C25.4082 24.5866 25.7637 22.5046 25.7637 20.1348C25.7637 17.765 25.4082 15.6914 24.6973 13.9141C24.0033 12.1198 22.9538 10.6217 21.5488 9.41992C20.4993 8.53971 19.2383 7.91341 17.7656 7.54102C16.3099 7.16862 14.0247 6.98242 10.9102 6.98242H6.54297V33.2871ZM0.5 38.7461V1.57422H8.65039C13.9486 1.57422 17.6725 1.84505 19.8223 2.38672C21.9889 2.91146 23.8848 3.80013 25.5098 5.05273C27.6595 6.69466 29.2845 8.80208 30.3848 11.375C31.502 13.9479 32.0605 16.8848 32.0605 20.1855C32.0605 23.4863 31.502 26.4147 30.3848 28.9707C29.2845 31.5098 27.6595 33.6087 25.5098 35.2676C23.8848 36.5202 22.0312 37.4173 19.9492 37.959C17.8841 38.4837 14.6595 38.7461 10.2754 38.7461H0.5Z" fill="white"/>
            <path d="M48.6752 17.418H49.767C52.9662 17.418 55.0905 17.0456 56.14 16.3008C57.1895 15.556 57.7142 14.2357 57.7142 12.3398C57.7142 10.2917 57.1472 8.85286 56.013 8.02344C54.8959 7.17708 52.8138 6.75391 49.767 6.75391H48.6752V17.418ZM48.2943 22.1152V38.7461H42.6322V1.57422H51.0619C53.5332 1.57422 55.446 1.73503 56.8002 2.05664C58.1712 2.37826 59.3392 2.91146 60.3041 3.65625C61.4551 4.55339 62.3438 5.71289 62.9701 7.13477C63.5964 8.55664 63.9095 10.1139 63.9095 11.8066C63.9095 14.7858 63.1901 17.1217 61.7513 18.8145C60.3125 20.4902 58.1882 21.4974 55.3783 21.8359L68.1752 38.7461H61.3451L48.9798 22.1152H48.2943Z" fill="white"/>
            <path d="M75.4206 38.7461V1.57422H96.1648V6.70312H81.4636V16.0215H96.1648V21.3281H81.4636V33.3379H96.1648V38.7461H75.4206Z" fill="white"/>
            <path d="M114.582 24.1465H124.941L121.133 15.666C120.913 15.1243 120.684 14.5065 120.447 13.8125C120.21 13.1016 119.973 12.3145 119.736 11.4512C119.533 12.2637 119.313 13.0254 119.076 13.7363C118.856 14.4303 118.628 15.0736 118.391 15.666L114.582 24.1465ZM131.289 38.7461L127.074 29.1738H112.348L108.031 38.7461H101.684L119.686 0.101562L137.662 38.7461H131.289Z" fill="white"/>
            <path d="M175.122 20.3887C175.055 20.1009 174.945 19.3053 174.792 18.002C174.657 16.9186 174.539 16.0215 174.437 15.3105C174.285 16.1569 174.065 17.0033 173.777 17.8496C173.506 18.696 173.159 19.5592 172.736 20.4395L163.011 40.2441L153.287 20.0332C152.88 19.2038 152.525 18.3997 152.22 17.6211C151.932 16.8424 151.678 16.0723 151.458 15.3105C151.442 16.0892 151.374 16.9102 151.255 17.7734C151.154 18.6198 150.993 19.5085 150.773 20.4395L146.787 38.7461H141.226L150.011 0L160.98 23.4609C161.149 23.8333 161.403 24.4512 161.742 25.3145C162.097 26.1777 162.52 27.2441 163.011 28.5137C163.367 27.4473 163.925 26.0931 164.687 24.4512C164.89 24.0111 165.042 23.6725 165.144 23.4355L175.859 0L184.847 38.7461H179.236L175.122 20.3887Z" fill="white"/>
            <path d="M218.711 17.1133H220.26C223.611 17.1133 225.846 16.7493 226.963 16.0215C228.08 15.2936 228.639 14.0072 228.639 12.1621C228.639 10.1816 228.038 8.78516 226.836 7.97266C225.651 7.16016 223.459 6.75391 220.26 6.75391H218.711V17.1133ZM218.33 22.0645V38.7461H212.668V1.57422H221.809C224.517 1.57422 226.506 1.72656 227.776 2.03125C229.062 2.31901 230.179 2.80143 231.127 3.47852C232.295 4.3418 233.209 5.50977 233.869 6.98242C234.529 8.43815 234.86 10.0462 234.86 11.8066C234.86 13.5671 234.529 15.1921 233.869 16.6816C233.209 18.1712 232.295 19.3392 231.127 20.1855C230.179 20.8626 229.062 21.3451 227.776 21.6328C226.506 21.9206 224.517 22.0645 221.809 22.0645H218.33Z" fill="white"/>
            <path d="M248.986 24.1465H259.345L255.537 15.666C255.317 15.1243 255.088 14.5065 254.851 13.8125C254.614 13.1016 254.377 12.3145 254.14 11.4512C253.937 12.2637 253.717 13.0254 253.48 13.7363C253.26 14.4303 253.031 15.0736 252.794 15.666L248.986 24.1465ZM265.693 38.7461L261.478 29.1738H246.751L242.435 38.7461H236.087L254.089 0.101562L272.066 38.7461H265.693Z" fill="white"/>
            <path d="M285.253 17.418H286.345C289.544 17.418 291.668 17.0456 292.718 16.3008C293.767 15.556 294.292 14.2357 294.292 12.3398C294.292 10.2917 293.725 8.85286 292.591 8.02344C291.474 7.17708 289.391 6.75391 286.345 6.75391H285.253V17.418ZM284.872 22.1152V38.7461H279.21V1.57422H287.64C290.111 1.57422 292.024 1.73503 293.378 2.05664C294.749 2.37826 295.917 2.91146 296.882 3.65625C298.033 4.55339 298.921 5.71289 299.548 7.13477C300.174 8.55664 300.487 10.1139 300.487 11.8066C300.487 14.7858 299.768 17.1217 298.329 18.8145C296.89 20.4902 294.766 21.4974 291.956 21.8359L304.753 38.7461H297.923L285.557 22.1152H284.872Z" fill="white"/>
            <path d="M311.998 38.7461V1.57422H318.041V16.9609L331.397 1.57422H338.785L324.059 18.1035L340.537 38.7461H332.742L318.041 19.7539V38.7461H311.998Z" fill="white"/>
          </svg>
        </div>
        若想了解更多資訊，歡迎填寫表單或來電洽詢，
        將由專人為您服務，謝謝！
      </div>
      <div class="order2 relative">
        <!-- <div class="order-title text-center text-white font-['noto_Serif_tc']">{{ info.order.title }}</div> -->
        <img class="line absolute" src="@/section/form/line.png" />
        <div class="stars">
          <img class="star absolute" src="@/section/form/star.svg" />
          <img class="star absolute" src="@/section/form/star.svg" />
          <img class="star absolute" src="@/section/form/star.svg" />
          <img class="star absolute" src="@/section/form/star.svg" />
          <img class="star absolute" src="@/section/form/star.svg" />
          <img class="star absolute" src="@/section/form/star.svg" />
          <img class="star absolute" src="@/section/form/star.svg" />
          <img class="star absolute" src="@/section/form/star.svg" />
          <img class="star absolute" src="@/section/form/star.png" />
        </div>
        <img class="butterfly1 absolute" src="@/section/s1/butterfly1.svg" />
        <img class="butterfly2 absolute" src="@/section/s1/butterfly2.svg" />
        <!-- Form -->
        <div class="form mx-auto relative flex items-start justify-center">
          <div class="left h-full flex flex-col justify-between items-center">
            <input type="text" placeholder="姓名" class="input w-full rounded-none" :value="formData.name"
              @input="(event) => (formData.name = event.target.value)" />
            <input type="text" placeholder="手機" class="input w-full rounded-none" :value="formData.phone"
              @input="(event) => (formData.phone = event.target.value)" />
            <select class="select w-full rounded-none" v-model="formData.room_type">
              <option value="" selected disabled>需求房型</option>
              <option value="兩房">兩房</option>
              <option value="三房">三房</option>
            </select>
            <select class="select w-full rounded-none" v-model="formData.city">
              <option value="" selected disabled>居住縣市</option>
              <option v-for="city in cityList" :value="city.value">
                {{ city.label }}
              </option>
            </select>
            <select class="select w-full rounded-none" v-model="formData.area">
              <option value="" selected disabled>居住地區</option>
              <option v-for="area in areaList" :value="area.value">
                {{ area.label }}
              </option>
            </select>
          </div>
          <div class="right h-full">
            <textarea :value="formData.msg" @input="(event) => (formData.msg = event.target.value)"
              class="textarea w-full h-full rounded-none" placeholder="備註訊息"></textarea>
          </div>
        </div>

        <!-- Policy -->
        <div class="flex gap-2 items-center justify-center control">
          <input type="checkbox" v-model="formData.policyChecked" :checked="formData.policyChecked"
            class="checkbox bg-white rounded-md" />
          <p class="text-white font-bold">
            本人知悉並同意<label for="policy-modal"
              class="modal-button text-[#FFF100] cursor-pointer hover:opacity-70">「個資告知事項聲明」</label>內容
          </p>
        </div>
        <Policy />

        <!-- Recaptcha -->
        <vue-recaptcha class="flex justify-center mt-8 z-10" ref="recaptcha" :sitekey="info.recaptcha_site_key_v2"
          @verify="onRecaptchaVerify" @expired="onRecaptchaUnVerify" />

        <!-- Send -->
        <div class="send mt-8 mx-auto hover:scale-90 btn cursor-pointer btregistration bg-transparent text-white rounded" @click="send()">
          {{ sending ? '發送中..' : '立即預約' }}
        </div>
      </div>

      <!-- Contact Info -->
      <ContactInfo />
    </div>

    <!-- Map -->
    <Map />

    <!-- HouseInfo -->
    <HouseInfo />
  </div>
</template>

<style lang="scss">
@import "@/assets/style/function.scss";

.order {
  overflow: hidden;
  width: 100%;
  // padding-top: size(115);

  .order1 {
    background-size: cover;
    background-position: center center;
    // padding-bottom: size(21);
    background-image: url(@/section/form/bg.jpg);
    padding-top: size(100);
  }

  .order2 {
    padding: size(33) 0 size(282) 0;
  }

  .title-logo {
    margin-left: auto;
    margin-right: auto;
    width: 340px;
  }

  .line {
    max-width: unset;
    bottom: -4vw;
    left: size(103);
    width: size(1820);
    mix-blend-mode: color-dodge;
  }

  .stars {
    .star {
      &:nth-child(1) {
        width: size(109);
        top: 140px;
        left: calc(50% - size(509 + 54.5));
        animation: 3s linear 1s infinite alternate twinkle;
      }

      &:nth-child(2) {
        width: size(199);
        top: -11vw;
        left: calc(50% - size(15 + 190));
        animation: 4s linear 0s infinite alternate twinkle;
      }

      &:nth-child(3) {
        width: size(87);
        top: calc(100% - 13vw);
        left: calc(50% + size(825));
        animation: 2.5s linear 0.5s infinite alternate twinkle;
      }

      &:nth-child(4) {
        width: size(115);
        top: -11vw;
        left: calc(50% + size(447));
        animation: 1.25s linear 1.5s infinite alternate twinkle;
      }

      &:nth-child(5) {
        width: size(91);
        top: calc(100% - 2vw);
        left: calc(50% - size(406 + 45));
        animation: 3.5s linear 0.5s infinite alternate twinkle;
      }

      &:nth-child(6) {
        width: size(115);
        top: 10vw;
        left: size(0.01);
        animation: 4s linear .7s infinite alternate twinkle;
      }

      &:nth-child(7) {
        width: size(81);
        top: 280px;
        left: calc(50% + size(700));
        animation: 4s linear 0s infinite alternate twinkle;
      }

      &:nth-child(8) {
        width: size(125);
        top: 540px;
        left: calc(50% - size(230));
        animation: 1.8s linear 0.5s infinite alternate twinkle;
      }

      &:nth-child(9) {
        width: size(168);
        top: 350px;
        left: calc(50% + size(250));
        animation: 2s linear 1.5s infinite alternate twinkle;
      }
    }
  }

  .butterfly1 {
    width: size(52);
    bottom: 10vw;
    left: size(1643);
    transform: translateY(80%);
    animation: an 3s linear infinite alternate;
  }

  .butterfly2 {
    width: size(46.47);
    bottom: 2vw;
    left: size(1330);
    transform: translateY(-20%);
    animation: an 1.5s linear infinite alternate;
  }

  .order-title {
    font-size: size(43);
    font-weight: 700;
    margin-bottom: size(45);
  }

  .z-10 {
    z-index: 10;
    position: relative;
  }

  .form {
    width: size(920);
    height: 270px;
    gap: size(80);
    margin-bottom: size(50);

    .left {
      width: size(419);
    }

    .right {
      width: size(419);
    }

    &::after {
      content: "";
      width: size(1);
      height: 100%;
      background-color: #fff;
      position: absolute;
    }
  }

  .send {
    font-size: size(22);
    letter-spacing: 0.9em;
    text-indent: 0.9em;
    width: size(350);
    height: 3.3em;
    line-height: 3.3;
    border: 0;
    z-index: 10;
    position: relative;
    border: size(1) solid #fff;
  }

  .control {
    font-size: size(16);
    color: #000;
    position: relative;
  }
}

@media screen and (max-width:768px) {
  .order {
    width: 100%;
    margin-top: size-m(0);

    .title {
      width: size-m(310);
      margin: 0 auto;
    }
    
    .order1 {
      background-image: url(@/section/form/bg-m.jpg);
      padding-bottom: 0;
      padding-top: size-m(60);
    }

    .order2 {
      padding: size-m(40) 0 size-m(70) 0;
      background-size: cover;
      background-position: center center;
    }

    .title-logo {
      width: 210px;
    }

    .line {
      bottom: -36vw;
      left: size-m(-527);
      width: size-m(991);
    }

    .stars {
      .star {
        &:nth-child(1) {
          width: size-m(34.53);
          top: -34vw;
          left: 82.128vw;
        }

        &:nth-child(2) {
          width: size-m(17.79);
          top: -35vw;
          left: size-m(104.11);
        }

        &:nth-child(3) {
          width: size-m(38.71);
          top: -1vw;
          left: size-m(47.64);
        }

        &:nth-child(4) {
          width: size-m(34);
          top: size-m(408);
          left: size-m(212.5);
        }

        &:nth-child(5) {
          width: size-m(35);
          top: size-m(35.56);
          left: size-m(314);
        }

        &:nth-child(6) {
          display: none;
        }

        &:nth-child(7) {
          display: none;
        }

        &:nth-child(8) {
          display: none;
        }

        &:nth-child(9) {
          display: none;
        }
      }
    }

    .butterfly1 {
      width: size-m(51.98);
      bottom: \50vw;
      left: size-m(287);
    }

    .butterfly2 {
      width: size-m(46.47);
      bottom: 87vw;
      left: size-m(56);
    }

    .order-title {
      font-size: size-m(29);
      font-weight: 500;
      margin-bottom: size-m(20);
    }

    .form {
      width: size-m(310);
      height: auto;
      gap: size-m(15);
      margin-bottom: size-m(20);
      flex-direction: column;

      .left {
        width: 100%;
        gap: size-m(15);
      }

      .right {
        width: 100%;
        height: size-m(100);
      }

      &::after {
        display: none;
      }
    }

    .send {
      font-size: size-m(21);
      width: size-m(318);
      border: size-m(1) solid #fff;
    }

    .control {
      font-size: size-m(14.6);
    }
  }
}
</style>

<script setup>
import Policy from "@/section/form/policy.vue"
import ContactInfo from "@/section/form/contactInfo.vue"
import Map from "@/section/form/map.vue"
import HouseInfo from "@/section/form/houseInfo.vue"

import info from "@/info"

import { cityList, renderAreaList } from "@/info/address.js"
import { ref, reactive, watch, onMounted } from "vue"
import { VueRecaptcha } from "vue-recaptcha"

import { useToast } from "vue-toastification"
const toast = useToast()

const formData = reactive({
  name: "",
  phone: "",
  room_type: "",
  // email: "",
  city: "",
  area: "",
  msg: "",
  policyChecked: false,
  r_verify: false,
})

const sending = ref(false)

//非必填
// const bypass = ["msg", "room_type", "email"]
const bypass = ["msg","room_type"];

//中文對照
const formDataRef = ref([
  "姓名", //name
  "手機", //phone
  "房型", //room_type
  // "信箱", //email
  "居住縣市", //city
  "居住地區", //area
  "備註訊息", //msg
  "個資告知事項聲明", //policyChecked
  "機器人驗證", //r_verify
])

const areaList = ref([])

watch(
  () => formData.city,
  (newVal, oldVal) => {
    areaList.value = renderAreaList(newVal)
    formData.area = areaList.value[0].value
  }
)

const onRecaptchaVerify = () => {
  formData.r_verify = true
}
const onRecaptchaUnVerify = () => {
  formData.r_verify = false
}

const send = () => {
  const urlParams = new URLSearchParams(window.location.search);
  const utmSource = urlParams.get("utm_source");
  const utmMedium = urlParams.get("utm_medium");
  const utmContent = urlParams.get("utm_content");
  const utmCampaign = urlParams.get("utm_campaign");
  const time = new Date();
  const year = time.getFullYear();
  const month = time.getMonth() + 1;
  const day = time.getDate();
  const hour = time.getHours();
  const min = time.getMinutes();
  const sec = time.getSeconds();
  const date = `${year}-${month}-${day} ${hour}:${min}:${sec}`;

  const presend = new FormData();
  let pass = true
  let unfill = []
  let idx = 0

  //驗證
  for (const [key, value] of Object.entries(formData)) {
    if (!bypass.includes(key)) {
      if (value == "" || value == false) {
        unfill.push(formDataRef.value[idx])
      }
    }
    idx++
    presend.append(key, value);
  }

  presend.append("utm_source", utmSource);
  presend.append("utm_medium", utmMedium);
  presend.append("utm_content", utmContent);
  presend.append("utm_campaign", utmCampaign);

  //有未填寫
  if (unfill.length > 0) {
    pass = false
    toast.error(`「${unfill.join(", ")}」為必填或必選`)
    return
  }

  //手機驗證
  const MobileReg = /^(09)[0-9]{8}$/
  if (!formData.phone.match(MobileReg)) {
    pass = false
    toast.error(`手機格式錯誤 ( 09開頭10位數字 )`)
    return
  }

  if (pass && !sending.value) {
    sending.value = true
    fetch(
      `https://script.google.com/macros/s/AKfycbyQKCOhxPqCrLXWdxsAaAH06Zwz_p6mZ5swK80USQ/exec?name=${formData.name}
      &phone=${formData.phone}
      &room_type=${formData.room_type}
      &project=${formData.project}
      &email=${formData.email}
      &cityarea=${formData.city}${formData.area}
      &msg=${formData.msg}
      &utm_source=${utmSource}
      &utm_medium=${utmMedium}
      &utm_content=${utmContent}
      &utm_campaign=${utmCampaign}
      &date=${date}
      &campaign_name=${info.caseName}`,
      {
        method: "GET"
      }
    );

    fetch("contact-form.php", {
      method: "POST",
      body: presend,
    }).then((response) => {
      if (response.status === 200) {
        window.location.href = "formThanks";
      }
      sending.value = false
    });


    // toast.success(`表單已送出，感謝您的填寫`)
  }
}
</script>